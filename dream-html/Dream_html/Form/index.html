<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Form (dream-html.Dream_html.Form)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../../../index.html">Index</a> &#x00BB; <a href="../../index.html">dream-html</a> &#x00BB; <a href="../index.html">Dream_html</a> &#x00BB; Form</nav><header class="odoc-preamble"><h1>Module <code><span>Dream_html.Form</span></code></h1><p>Typed, extensible HTML form decoder with error reporting for form field validation failures. Powerful chained decoding functionality–the validation of one field can depend on the values of other decoded fields.</p><p>See the bottom of the page for complete examples.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 3.7.0.</li></ul></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#basic-type-decoders">Basic type decoders</a></li><li><a href="#forms-and-fields">Forms and fields</a></li><li><a href="#form-decoders">Form decoders</a></li><li><a href="#error-keys">Error keys</a></li><li><a href="#examples">Examples</a><ul><li><a href="#basic-functionality">Basic functionality</a></li><li><a href="#repeated-values">Repeated values</a></li><li><a href="#constrained-field-values">Constrained field values</a></li><li><a href="#complex-validation-rules">Complex validation rules</a></li><li><a href="#decode_multiple">Multiple structured values</a></li></ul></li></ul></nav></div><div class="odoc-content"><h3 id="basic-type-decoders"><a href="#basic-type-decoders" class="anchor"></a>Basic type decoders</h3><div class="odoc-spec"><div class="spec type anchored" id="type-ty"><a href="#type-ty" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a ty</span></span><span> = <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'a</span>, string)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p>The type of a decoder for a single form field value of type <code>'a</code> which can successfully decode the field value or fail with an error message key.</p></div></div><p>In the following type decoders, the minimum and maximum values are all <i>inclusive</i>.</p><div class="odoc-spec"><div class="spec value anchored" id="val-bool"><a href="#val-bool" class="anchor"></a><code><span><span class="keyword">val</span> bool : <span>bool <a href="#type-ty">ty</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-char"><a href="#val-char" class="anchor"></a><code><span><span class="keyword">val</span> char : <span><span class="optlabel">?min</span>:char <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?max</span>:char <span class="arrow">&#45;&gt;</span></span> <span>char <a href="#type-ty">ty</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-float"><a href="#val-float" class="anchor"></a><code><span><span class="keyword">val</span> float : <span><span class="optlabel">?min</span>:float <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?max</span>:float <span class="arrow">&#45;&gt;</span></span> <span>float <a href="#type-ty">ty</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-int"><a href="#val-int" class="anchor"></a><code><span><span class="keyword">val</span> int : <span><span class="optlabel">?min</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?max</span>:int <span class="arrow">&#45;&gt;</span></span> <span>int <a href="#type-ty">ty</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-int32"><a href="#val-int32" class="anchor"></a><code><span><span class="keyword">val</span> int32 : <span><span class="optlabel">?min</span>:int32 <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?max</span>:int32 <span class="arrow">&#45;&gt;</span></span> <span>int32 <a href="#type-ty">ty</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-int64"><a href="#val-int64" class="anchor"></a><code><span><span class="keyword">val</span> int64 : <span><span class="optlabel">?min</span>:int64 <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?max</span>:int64 <span class="arrow">&#45;&gt;</span></span> <span>int64 <a href="#type-ty">ty</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-string"><a href="#val-string" class="anchor"></a><code><span><span class="keyword">val</span> string : <span><span class="optlabel">?min_length</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?max_length</span>:int <span class="arrow">&#45;&gt;</span></span> <span>string <a href="#type-ty">ty</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-unix_tm"><a href="#val-unix_tm" class="anchor"></a><code><span><span class="keyword">val</span> unix_tm : <span><span class="optlabel">?min</span>:<span class="xref-unresolved">Unix</span>.tm <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?max</span>:<span class="xref-unresolved">Unix</span>.tm <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Unix</span>.tm <a href="#type-ty">ty</a></span></span></code></div><div class="spec-doc"><p>This can parse strings with the formats <code>2024-01-01</code> or <code>2024-01-01T00:00:00</code> into a timestamp.</p><p>Note that this is <i>not</i> timezone-aware.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 3.8.0</li></ul></div></div><h3 id="forms-and-fields"><a href="#forms-and-fields" class="anchor"></a>Forms and fields</h3><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span></code></div><div class="spec-doc"><p>The type of a form (a form field by itself is also considered a form) which can decode values of type <code>'a</code> or fail with a list of error message keys.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ok"><a href="#val-ok" class="anchor"></a><code><span><span class="keyword">val</span> ok : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>ok value</code> is a form field that always successfully returns <code>value</code>.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 3.8.0</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error"><a href="#val-error" class="anchor"></a><code><span><span class="keyword">val</span> error : <span>string <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>error name message</code> is a form field that always errors the field <code>name</code> with the <code>message</code>.</p><p>These allow adding adding further checks to the entire form using all decoded field values and then attaching more errors to specific fields (or not).</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 3.8.0</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-list"><a href="#val-list" class="anchor"></a><code><span><span class="keyword">val</span> list : <span><span class="optlabel">?min_length</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?max_length</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-ty">ty</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>list ?min_length ?max_length ty name</code> is a form field which can decode a list of values which can each be decoded by <code>ty</code>. The list must have at least <code>min_length</code> and at most <code>max_length</code> (inclusive).</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-optional"><a href="#val-optional" class="anchor"></a><code><span><span class="keyword">val</span> optional : <span><span><span class="type-var">'a</span> <a href="#type-ty">ty</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> option</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>optional ty name</code> is a form field which can decode an optional value from the form.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-required"><a href="#val-required" class="anchor"></a><code><span><span class="keyword">val</span> required : <span><span class="optlabel">?default</span>:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-ty">ty</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>required ?default ty name</code> is a form field which can decode a required value from the form. If at least one value corresponding to the given <code>name</code> does not appear in the form, and if a <code>default</code> value is not specified, the decoding fails with an error.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-multiple"><a href="#val-multiple" class="anchor"></a><code><span><span class="keyword">val</span> multiple : <span>int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>int <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> list</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>multiple n form</code> is a form which can decode a list of nested form values. It tries to decode exactly <code>n</code> values and fails if it can't find all of them. Assumes that the items are 0-indexed. See <a href="#decode_multiple" title="decode_multiple">Multiple structured values</a> for a complete example.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 3.10.0</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ensure"><a href="#val-ensure" class="anchor"></a><code><span><span class="keyword">val</span> ensure : 
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> bool)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span class="type-var">'a</span> <a href="#type-ty">ty</a></span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-t">t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-ty">ty</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'b</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>ensure message condition field ty name</code> is a form field which imposes an additional <code>condition</code> on top of the existing <code>field</code>. If the condition fails, the result is an error <code>message</code>. It is suggested that the <code>message</code> be a translation key so that the application can be localized to different languages.</p></div></div><h3 id="form-decoders"><a href="#form-decoders" class="anchor"></a>Form decoders</h3><div class="odoc-spec"><div class="spec value anchored" id="val-(let*)"><a href="#val-(let*)" class="anchor"></a><code><span><span class="keyword">val</span> (let*) : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-t">t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>let* start_date = required unix_tm &quot;start-date&quot;</code> decodes a form field and allows accessing it in the subsequent decoders. Eg:</p><pre class="language-ocaml"><code>  let* start_date = required unix_tm &quot;start-date&quot; in
  let+ end_date = required (unix_tm ~min:start_date) &quot;end-date&quot; in
  ...</code></pre><p>However, note that <code>let*</code> uses a 'fail-fast' decoding strategy. If there is a decoding error, it immediately returns the error without decoding the subsequent fields. (Which makes sense if you think about the example above.) So, in order to ensure complete error reporting for all fields, you would need to use <code>let+</code> and <code>and+</code>.</p><ul class="at-tags"><li class="since"><span class="at-tag">since</span> 3.8.0</li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(let+)"><a href="#val-(let+)" class="anchor"></a><code><span><span class="keyword">val</span> (let+) : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>let+ email = required string &quot;email&quot;</code> decodes a form field named <code>email</code> as a <code>string</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(and+)"><a href="#val-(and+)" class="anchor"></a><code><span><span class="keyword">val</span> (and+) : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'a</span> * <span class="type-var">'b</span>)</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>and+ password = required string &quot;password&quot;</code> continues decoding in an existing form declaration and decodes a form field <code>password</code> as a <code>string</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(or)"><a href="#val-(or)" class="anchor"></a><code><span><span class="keyword">val</span> (or) : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>form1 or form2</code> is <code>form1</code> if it succeeds, else <code>form2</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-validate"><a href="#val-validate" class="anchor"></a><code><span><span class="keyword">val</span> validate : 
  <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span><span>(string * string)</span> list</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>validate form values</code> is a result of validating the given <code>form</code>'s <code>values</code>. It may be either some value of type <code>'a</code> or a list of form field names and the corresponding error message keys.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_error"><a href="#val-pp_error" class="anchor"></a><code><span><span class="keyword">val</span> pp_error : <span><span><span>(string * string)</span> list</span> <span class="xref-unresolved">Fmt</span>.t</span></span></code></div><div class="spec-doc"><p><code>pp_error</code> is a helper pretty-printer for debugging/troubleshooting form validation errors.</p></div></div><h3 id="error-keys"><a href="#error-keys" class="anchor"></a>Error keys</h3><p>When errors are reported, the following keys are used instead of English strings. These keys can be used for localizing the error messages. The suggested default English translations are given below.</p><p>These keys are modelled after <a href="https://github.com/playframework/playframework/blob/6f5129e6e3b9c784948b56d486d1ef1e5efef163/core/play/src/main/resources/messages.default">Play Framework</a>.</p><div class="odoc-spec"><div class="spec value anchored" id="val-error_expected_bool"><a href="#val-error_expected_bool" class="anchor"></a><code><span><span class="keyword">val</span> error_expected_bool : string</span></code></div><div class="spec-doc"><p>Please enter <code>true</code> or <code>false</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_expected_char"><a href="#val-error_expected_char" class="anchor"></a><code><span><span class="keyword">val</span> error_expected_char : string</span></code></div><div class="spec-doc"><p>Please enter a single character.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_expected_single"><a href="#val-error_expected_single" class="anchor"></a><code><span><span class="keyword">val</span> error_expected_single : string</span></code></div><div class="spec-doc"><p>Please enter a single value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_expected_int"><a href="#val-error_expected_int" class="anchor"></a><code><span><span class="keyword">val</span> error_expected_int : string</span></code></div><div class="spec-doc"><p>Please enter a valid integer.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_expected_int32"><a href="#val-error_expected_int32" class="anchor"></a><code><span><span class="keyword">val</span> error_expected_int32 : string</span></code></div><div class="spec-doc"><p>Please enter a valid 32-bit integer.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_expected_int64"><a href="#val-error_expected_int64" class="anchor"></a><code><span><span class="keyword">val</span> error_expected_int64 : string</span></code></div><div class="spec-doc"><p>Please enter a valid 64-bit integer.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_expected_number"><a href="#val-error_expected_number" class="anchor"></a><code><span><span class="keyword">val</span> error_expected_number : string</span></code></div><div class="spec-doc"><p>Please enter a valid number.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_expected_time"><a href="#val-error_expected_time" class="anchor"></a><code><span><span class="keyword">val</span> error_expected_time : string</span></code></div><div class="spec-doc"><p>Please enter a valid date or date-time.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_length"><a href="#val-error_length" class="anchor"></a><code><span><span class="keyword">val</span> error_length : string</span></code></div><div class="spec-doc"><p>Please enter a value of the expected length.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_range"><a href="#val-error_range" class="anchor"></a><code><span><span class="keyword">val</span> error_range : string</span></code></div><div class="spec-doc"><p>Please enter a value in the expected range.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-error_required"><a href="#val-error_required" class="anchor"></a><code><span><span class="keyword">val</span> error_required : string</span></code></div><div class="spec-doc"><p>Please enter a value.</p></div></div><h3 id="examples"><a href="#examples" class="anchor"></a>Examples</h3><h4 id="basic-functionality"><a href="#basic-functionality" class="anchor"></a>Basic functionality</h4><pre class="language-ocaml"><code>  type user =
    { name : string;
      age : int option
    }

  open Dream_html.Form

  let user_form =
    let+ name = required string &quot;name&quot;
    and+ age = optional (int ~min:16) &quot;age&quot; in
    (* Thanks, Australia! *)
    { name; age }

  let dream_form = [&quot;age&quot;, &quot;42&quot;; &quot;name&quot;, &quot;Bob&quot;]
  let user_result = validate user_form dream_form</code></pre><p>Result: <code>Ok { name = &quot;Bob&quot;; age = Some 42 }</code></p><p>Sad path:</p><pre class="language-ocaml"><code>  validate user_form [&quot;age&quot;, &quot;none&quot;]</code></pre><p>Result: <code>Error [(&quot;age&quot;, &quot;error.expected.int&quot;); (&quot;name&quot;, &quot;error.required&quot;)]</code></p><h4 id="repeated-values"><a href="#repeated-values" class="anchor"></a>Repeated values</h4><pre class="language-ocaml"><code>  type plan =
    { id : string;
      features : string list
    }

  let plan_form =
    let+ id = required string &quot;id&quot;
    and+ features = list string &quot;features&quot; in
    { id; features } validate plan_form [&quot;id&quot;, &quot;foo&quot;]</code></pre><p>Result: <code>Ok {id = &quot;foo&quot;; features = []}</code></p><pre class="language-ocaml"><code>  validate plan_form [&quot;id&quot;, &quot;foo&quot;; &quot;features&quot;, &quot;f1&quot;; &quot;features&quot;, &quot;f2&quot;]</code></pre><p>Result: <code>Ok {id = &quot;foo&quot;; features = [&quot;f1&quot;; &quot;f2&quot;]}</code></p><p>Note that the names can be anything, eg <code>&quot;features[]&quot;</code> if you prefer.</p><h4 id="constrained-field-values"><a href="#constrained-field-values" class="anchor"></a>Constrained field values</h4><pre class="language-ocaml"><code>  let plan_form =
    let+ id =
      ensure &quot;error.expected.nonempty&quot; (( &lt;&gt; ) &quot;&quot;) required string &quot;id&quot;
    and+ features = list string &quot;features&quot; in
    { id; features } validate plan_form [&quot;id&quot;, &quot;&quot;]</code></pre><p>Result: <code>Error [(&quot;id&quot;, &quot;error.expected.nonempty&quot;)]</code></p><h4 id="complex-validation-rules"><a href="#complex-validation-rules" class="anchor"></a>Complex validation rules</h4><p>Using chained validation rules where some fields depend on others:</p><pre class="language-ocaml"><code>  type req =
    { id : string;
      years : int option;
      months : int option;
      weeks : int option;
      days : int option
    }

  let req_form =
    let+ id = required string &quot;id&quot; (* Both id... *)
    and+ days, weeks, months, years =
      (* ...and period are required *)
      let* days = optional int &quot;days&quot; in
      let* weeks = optional int &quot;weeks&quot; in
      let* months = optional int &quot;months&quot; in
      let* years = optional int &quot;years&quot; in
      match days, weeks, months, years with
      | None, None, None, None -&gt; error &quot;years&quot; &quot;Please enter a period&quot;
      (* Only one period component is required *)
      | _ -&gt; ok (days, weeks, months, years)
    in
    { id; days; weeks; months; years } validate req []</code></pre><p>Result: <code>Error [(&quot;years&quot;, &quot;Please enter a period&quot;); (&quot;id&quot;, &quot;error.required&quot;)]</code></p><h4 id="decode_multiple"><a href="#decode_multiple" class="anchor"></a>Multiple structured values</h4><p>Suppose you have the following form data submitted:</p><pre class="language-ocaml"><code>  item-count: 2
  item[0].id: abc
  item[0].qty: 1
  item[1].id: def
  item[1].qty: 10
  item[1].discount: 25</code></pre><p>And you want to decode it into the following types:</p><pre class="language-ocaml"><code>  type item =
    { id : string;
      qty : int;
      discount : int
    }

  type invoice =
    { item_count : int;
      items : item list
    }</code></pre><p>First create the indexed invoice item decoder and invoice decoder:</p><pre class="language-ocaml"><code>  let item n =
    let nth name = &quot;item[&quot; ^ string_of_int n ^ &quot;].&quot; ^ name in
    let+ id = required string (nth &quot;id&quot;)
    and+ qty = required int (nth &quot;qty&quot;)
    and+ discount = required ~default:0 int (nth &quot;discount&quot;) in
    { id; qty; discount }

  let invoice =
    let* item_count = required int &quot;item-count&quot; in
    let+ items = multiple item_count item in
    { item_count; items }</code></pre><p>Try it:</p><pre class="language-ocaml"><code>  validate invoice
    [ &quot;item[0].id&quot;, &quot;abc&quot;;
      &quot;item[0].qty&quot;, &quot;1&quot;;
      &quot;item[1].id&quot;, &quot;def&quot;;
      &quot;item[1].qty&quot;, &quot;10&quot;;
      &quot;item[1].discount&quot;, &quot;25&quot;;
      &quot;item-count&quot;, &quot;2&quot; ]</code></pre><p>Result:</p><pre class="language-ocaml"><code>  Ok
    { item_count = 2;
      items =
        [ { id = &quot;def&quot;; qty = 10; discount = 25 };
          { id = &quot;abc&quot;; qty = 1; discount = 0 } ]
    }</code></pre><p>Validation error:</p><pre class="language-ocaml"><code>  validate invoice
    [ &quot;item[0].qty&quot;, &quot;1&quot;;
      &quot;item[1].id&quot;, &quot;def&quot;;
      &quot;item[1].discount&quot;, &quot;25&quot;;
      &quot;item-count&quot;, &quot;2&quot; ]
    Error
    [item [0].id, error.required; item [1].qty, error.required]</code></pre></div></body></html>
